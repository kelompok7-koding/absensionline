<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Online - SMAN 1 Dramaga</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Ikon (Heroicons) -->
    <script src="https://unpkg.com/heroicons@2.1.1/dist/solid.js" defer></script>

    <style>
        /* Menggunakan font Inter sebagai default */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Sembunyikan elemen yang tidak ingin dicetak */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                margin: 0;
                padding: 0;
            }
            .print-container {
                padding: 2rem;
                border: none;
                box-shadow: none;
            }
            #attendanceTablePrint {
                display: block !important;
            }
            #guruPageContainer, #sekretarisPageContainer {
                display: none !important;
            }
        }

        /* Tampilan custom untuk print */
        @page {
            size: A4;
            margin: 20mm;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Kontainer Aplikasi Utama -->
    <div id="appContainer">

        <!-- ====================================================== -->
        <!--                      HALAMAN LOGIN                     -->
        <!-- ====================================================== -->
        <div id="loginPage" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 p-4">
            <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl text-center">
                <h1 class="text-3xl font-extrabold text-blue-700 mb-2">SMA NEGERI 1 DRAMAGA</h1>
                <p class="text-gray-600 mb-8 text-lg">Aplikasi Absensi Online</p>

                <div class="space-y-6">
                    <!-- Pemilihan Peran -->
                    <div>
                        <label for="roleSelect" class="block text-left text-sm font-medium text-gray-700 mb-1">Pilih Peran Anda</label>
                        <select id="roleSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="siswa">Siswa</option>
                            <option value="admin">Admin</option>
                            <option value="guru">Guru (Wali Kelas)</option>
                            <option value="sekretaris">Sekretaris Kelas</option>
                        </select>
                    </div>

                    <!-- Input Password (untuk Admin, Guru, Sekretaris) -->
                    <div id="passwordContainer" class="hidden">
                        <label for="passwordInput" class="block text-left text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="passwordInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan password...">
                    </div>

                    <!-- Pemilihan Nama Siswa (untuk Siswa) -->
                    <div id="studentSelectContainer">
                        <label for="studentSelect" class="block text-left text-sm font-medium text-gray-700 mb-1">Pilih Nama Anda</Tlabel>
                        <select id="studentSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Pilih Nama --</option>
                            <!-- Nama siswa akan diisi oleh JavaScript -->
                        </select>
                    </div>

                    <!-- Tombol Login -->
                    <button id="loginButton" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold text-lg shadow-lg hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Masuk
                    </button>

                    <!-- Pesan Error -->
                    <p id="loginError" class="text-red-500 text-sm hidden"></p>
                </div>
            </div>
        </div>

        <!-- ====================================================== -->
        <!--                      HALAMAN ADMIN                     -->
        <!-- ====================================================== -->
        <div id="adminPage" class="hidden min-h-screen bg-gray-50">
            <!-- Header Admin -->
            <header class="bg-white shadow-md no-print">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800">Dashboard Admin</h1>
                    <button id="adminLogoutButton" class="bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition">Logout</button>
                </div>
            </header>
            
            <!-- Konten Admin -->
            <main class="max-w-7xl mx-auto p-6 space-y-8">
                <!-- Kelola Siswa -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4">Kelola Siswa (X-C)</h2>
                    <div class="flex gap-4 mb-4">
                        <input type="text" id="adminStudentNameInput" class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nama Siswa Baru...">
                        <button id="adminAddStudentButton" class="bg-blue-500 text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-600">Tambah</button>
                    </div>
                    <ul id="adminStudentList" class="list-decimal list-inside space-y-2 max-h-60 overflow-y-auto">
                        <!-- Daftar siswa akan diisi oleh JavaScript -->
                    </ul>
                </div>

                <!-- Kelola Guru -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4">Kelola Guru</h2>
                    <div class="flex gap-4 mb-4">
                        <input type="text" id="adminTeacherNameInput" class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nama Guru Baru...">
                        <button id="adminAddTeacherButton" class="bg-blue-500 text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-600">Tambah</button>
                    </div>
                    <ul id="adminTeacherList" class="list-disc list-inside space-y-2">
                        <!-- Daftar guru akan diisi oleh JavaScript -->
                    </ul>
                </div>

                <!-- Kelola Sekretaris -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4">Kelola Sekretaris</h2>
                    <div class="flex gap-4 mb-4">
                        <input type="text" id="adminSecretaryNameInput" class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nama Sekretaris Baru...">
                        <!-- Di masa depan, bisa tambahkan pilihan kelas di sini -->
                        <button id="adminAddSecretaryButton" class="bg-blue-500 text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-600">Tambah</button>
                    </div>
                    <ul id="adminSecretaryList" class="list-disc list-inside space-y-2">
                        <!-- Daftar sekretaris akan diisi oleh JavaScript -->
                    </ul>
                </div>
            </main>
        </div>

        <!-- ====================================================== -->
        <!--                HALAMAN GURU & SEKRETARIS               -->
        <!-- ====================================================== -->
        <div id="teacherPage" class="hidden min-h-screen bg-gray-50">
            <!-- Header Guru/Sekretaris -->
            <header class="bg-white shadow-md no-print">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                    <h1 id="teacherHeaderTitle" class="text-2xl font-bold text-gray-800">Dashboard Guru</h1>
                    <button id="teacherLogoutButton" class="bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition">Logout</button>
                </div>
            </header>
            
            <!-- Konten Guru/Sekretaris -->
            <main id="guruPageContainer" class="max-w-7xl mx-auto p-6 space-y-6 no-print">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div>
                            <h2 class="text-xl font-semibold">Absensi Kelas X-C</h2>
                            <p class="text-gray-600">Wali Kelas: <span id="waliKelasName">Damis Dewi Sundani, M.pd.</span></p>
                        </div>
                        <div class="flex items-center gap-4">
                            <label for="attendanceDate" class="font-medium">Tanggal:</label>
                            <input type="date" id="attendanceDate" class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="printReportButton" class="hidden bg-green-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-600">
                                Kirim/Cetak Laporan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabel Absensi -->
                <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Daftar Hadir Siswa</h3>
                        <button id="saveAttendanceButton" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                            Simpan Perubahan
                        </button>
                    </div>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Absen</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Baris absensi akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </main>
            
            <!-- Container Khusus untuk Cetak -->
            <div id="attendanceTablePrint" class="hidden print-container">
                <h1 class="text-2xl font-bold text-center mb-2">Laporan Absensi SMA NEGERI 1 DRAMAGA</h1>
                <h2 class="text-xl font-semibold text-center mb-4">Kelas: X-C</h2>
                <div class="flex justify-between mb-4">
                    <p><strong>Wali Kelas:</strong> Damis Dewi Sundani, M.pd.</p>
                    <p><strong>Tanggal:</strong> <span id="printDate"></span></p>
                </div>
                <table class="min-w-full divide-y divide-gray-300 border border-gray-300">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700 border">No.</th>
                            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700 border">Nama Siswa</th>
                            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700 border">Status</th>
                            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700 border">Waktu</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTablePrintBody" class="divide-y divide-gray-200">
                        <!-- Diisi oleh JS saat mencetak -->
                    </tbody>
                </table>
                <div class="mt-8">
                    <p class="text-sm">Dicetak pada: <span id="printTimestamp"></span></p>
                </div>
            </div>
        </div>

        <!-- ====================================================== -->
        <!--                      HALAMAN SISWA                     -->
        <!-- ====================================================== -->
        <div id="siswaPage" class="hidden flex items-center justify-center min-h-screen bg-gray-100 p-4">
            <div class="bg-white w-full max-w-lg p-10 rounded-2xl shadow-xl text-center">
                <button id="siswaLogoutButton" class="absolute top-6 right-6 bg-red-100 text-red-600 px-4 py-2 rounded-lg font-medium hover:bg-red-200 transition text-sm no-print">Logout</button>
                
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Selamat Datang,</h1>
                <p id="siswaNameDisplay" class="text-2xl font-semibold text-blue-600 mb-8"></p>

                <div id="siswaLoading" class="hidden">
                    <p class="text-gray-600">Memeriksa status absensi...</p>
                </div>

                <div id="siswaAttendButtonContainer" class="hidden">
                    <p class="text-gray-600 mb-6 text-lg">Silakan lakukan absensi untuk hari ini.</p>
                    <button id="siswaAttendButton" class="w-full bg-green-500 text-white py-6 rounded-lg font-bold text-2xl shadow-lg hover:bg-green-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        KLIK UNTUK HADIR
                    </button>
                </div>

                <div id="siswaAttendedContainer" class="hidden">
                    <p class="text-xl font-medium text-green-700 mb-4">Anda sudah berhasil absen!</p>
                    <p class="text-gray-700">Waktu Absen:</p>
                    <p id="siswaTimestampDisplay" class="text-lg font-semibold text-gray-900"></p>
                </div>

                <div class="mt-10 pt-6 border-t border-gray-200">
                    <p class="text-gray-600">Jika <span class="font-semibold">Sakit</span> atau <span class="font-semibold">Izin</span>, harap segera hubungi Sekretaris Kelas atau Wali Kelas Anda.</p>
                </div>
            </div>
        </div>

    </div> <!-- Akhir AppContainer -->

    <!-- ====================================================== -->
    <!--                     SKRIP JAVASCRIPT                   -->
    <!-- ====================================================== -->
    <script type="module">
        // Impor fungsi-fungsi Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            updateDoc,
            arrayUnion,
            arrayRemove,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Konfigurasi Firebase ---
        // (Gunakan config yang disediakan oleh environment)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'absensi-smandramaga-default';
        
        // Inisialisasi Firebase
        let app, db, auth;
        let userId = null;
        let currentRole = null;
        let currentStudentName = null;
        let attendanceUnsubscribe = null; // Untuk listener realtime
        let adminListsUnsubscribe = {}; // Untuk listener admin

        // --- Data Awal (Hardcoded) ---
        const INITIAL_STUDENT_LIST_XC = [
            "Abi Toriq Makatita", "Addini Urwah Hanifah", "Ahmad Zaky", "Aira Dwi Cahyani", 
            "Allysa Putri Abimanyu", "Anela Agustin", "Arya Galih", "Asyila Nayla Nazwa",
            "Bintang Fidelya Rafa Azzahra", "Cleotasya Aurora Kristianto Putri", "Daffa Almer Yofa",
            "Elsa Zullia", "Erlangga Saputra", "Febby Adinda Putri", "Febriansyah", 
            "Ghina Nurani Suryansyah", "Haya Diya Syaima", "Jihan Navasyah Mahadi",
            "Kayla Raimanda Almiratuzahwa", "Khalisa Khansa Ramadaniyah", "Labieb Kamil Al-Fakhry",
            "Mahdian Ningsih", "Mohamad Rizki", "Muhammad Fazri Ramadhan", "Muhammad Rizki Abqhary",
            "Muhammad Alif Al Faruq", "Muhammad Faris Qurthubi", "Muhammad Naufal Munadil Fazri",
            "Muhammad Tian Arizki", "Mutia Larasati", "Nahdatussyakila Al-Amsir", 
            "Nazreen Ananda Saliha", "Niken Felysha Andrean", "Panya Azura", "Raden Indra Bayu Hartono",
            "Ratu Fatimah Az Zahra", "Raya Falah Dewantara", "Rinanti Putri", "Salwa Nurul Aini",
            "Satria Dwi Andika", "Shakira Aisyah Putri", "Siti Huzaimah", "Sonya Maryam Azzahra",
            "Syra Nur Hidayah", "Vira Yusrin Aulia", "Wahid Maulana Fahmi", "Zahra Khumaira"
        ];
        const INITIAL_TEACHERS = ["Damis Dewi Sundani, M.pd."];
        const INITIAL_SECRETARIES = ["Allysa Putri Abimanyu", "Ghina Nurani Suryansyah"];
        const CLASS_NAME = "X-C";
        const WALI_KELAS = "Damis Dewi Sundani, M.pd.";

        // --- Elemen DOM ---
        const loginPage = document.getElementById('loginPage');
        const adminPage = document.getElementById('adminPage');
        const teacherPage = document.getElementById('teacherPage');
        const siswaPage = document.getElementById('siswaPage');

        const roleSelect = document.getElementById('roleSelect');
        const passwordContainer = document.getElementById('passwordContainer');
        const passwordInput = document.getElementById('passwordInput');
        const studentSelectContainer = document.getElementById('studentSelectContainer');
        const studentSelect = document.getElementById('studentSelect');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');

        // Tombol Logout
        const adminLogoutButton = document.getElementById('adminLogoutButton');
        const teacherLogoutButton = document.getElementById('teacherLogoutButton');
        const siswaLogoutButton = document.getElementById('siswaLogoutButton');

        // Halaman Admin
        const adminStudentNameInput = document.getElementById('adminStudentNameInput');
        const adminAddStudentButton = document.g
